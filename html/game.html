<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/all.min.css">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/jquery-ui.css">
  <link rel="stylesheet" href="../css/jquery-ui.structure.min.css">
  <link rel="stylesheet" href="../css/jquery-ui.theme.min.css">
  <script src="../js/jquery-3.5.1.min.js"></script>
  <script src="../js/jquery-ui.js"></script>
  <link rel="stylesheet" href="../css/summernote-lite.min.css">
  <script src="../js/summernote-lite.min.js"></script>
  <script src="../js/summernote-ko-KR.min.js"></script>
  <title>Document</title>
  <style>
    #app{
      /* position: absolute;
      bottom: 5%; */
    }
    table{
      border-collapse: separate;
      border-spacing: 0;
    }
    .block{
      border: 1px solid black;
      width: 30px;
      height: 30px;

    }
    .empty{
      background-color: white;
    }
    .notEmpty{
      background-color: black;
    }
    .pad{
        position: absolute;
        bottom: 5%;
        right: 5%;
        width: 100px;
        height: 100px;
    }
    #up{
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translate(-50%,-50%);
    }
    #left{
      position: absolute;
      bottom: 50%;
      left: 0%;
      transform: translate(-50%,-50%);
    }
    #right{
      position: absolute;
      bottom: 50%;
      left: 100%;
      transform: translate(-50%,-50%);
    }
    #down{
      position: absolute;
      bottom: 0%;
      left: 50%;
      transform: translate(-50%,-50%);
    }
    #space{
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
    }
    span i{
      font-size: 2em;
    }

  </style>
</head>
<body>

  <div id="app"></div>
  <div class="pad">
    <span id="up"onclick="evet(38);"><i class="fas fa-arrow-circle-up"></i></span>
    <span id="left"onclick="evet(37);"><i class="fas fa-arrow-circle-left"></i></span>
    <span id="right"onclick="evet(39);"><i class="fas fa-arrow-circle-right"></i></span>
    <span id="space"onclick="evet(32);"><i class="far fa-circle"></i></span>
    <span id="down" onclick="evet(40);"><i class="fas fa-arrow-circle-down"></i></span>
  </div>


  <script>

    //ui
    //현좌표 +1
    //블럭범위(좌표크기)를 넘으면 그대로
    //
    //좌표 존재하면 
    //


    var x = 10;
    var y = 10;


    class UI{
      #view = [];
      #x = 0;
      #y = 0;
      #app;
      #tableBody;
      #current = {};
      #currentCopy = {};
      #prevShape = [];
      #pos = false;
      #posN = 0;
      #shape = {
        0:{0:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:1,y:2}},
           1:{0:{x:2,y:0},1:{x:2,y:1},2:{x:1,y:1},3:{x:0,y:1}},
           2:{0:{x:1,y:2},1:{x:0,y:2},2:{x:0,y:1},3:{x:0,y:0}},
           3:{0:{x:0,y:1},1:{x:0,y:0},2:{x:1,y:0},3:{x:2,y:0}},
        },//기억
        1:{0:{0:{x:0,y:1},1:{x:0,y:0},2:{x:1,y:0},3:{x:2,y:0}},
           1:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:1,y:2}},
           2:{0:{x:2,y:0},1:{x:2,y:1},2:{x:1,y:1},3:{x:0,y:1}},
           3:{0:{x:0,y:0},1:{x:0,y:1},2:{x:0,y:2},3:{x:1,y:2}},
        },
        2:{0:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:0,y:1}},
           1:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:0,y:1}},
           2:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:0,y:1}},
           3:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:0,y:1}},
        },
        3:{0:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:2,y:1}},
           1:{0:{x:1,y:0},1:{x:1,y:1},2:{x:0,y:1},3:{x:0,y:2}},
           2:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:2,y:1}},
           3:{0:{x:1,y:0},1:{x:1,y:1},2:{x:0,y:1},3:{x:0,y:2}},
        },
        4:{0:{0:{x:0,y:1},1:{x:1,y:1},2:{x:1,y:0},3:{x:2,y:0}},
           1:{0:{x:0,y:0},1:{x:0,y:1},2:{x:1,y:1},3:{x:1,y:2}},
           2:{0:{x:0,y:1},1:{x:1,y:1},2:{x:1,y:0},3:{x:2,y:0}},
           3:{0:{x:0,y:0},1:{x:0,y:1},2:{x:1,y:1},3:{x:1,y:2}},
        },
        5:{0:{0:{x:0,y:0},1:{x:1,y:0},2:{x:2,y:0},3:{x:3,y:0}},
           1:{0:{x:0,y:0},1:{x:0,y:1},2:{x:0,y:2},3:{x:0,y:3}},
           2:{0:{x:0,y:0},1:{x:1,y:0},2:{x:2,y:0},3:{x:3,y:0}},
           3:{0:{x:0,y:0},1:{x:0,y:1},2:{x:0,y:2},3:{x:0,y:3}},
        },
        6:{0:{0:{x:1,y:0},1:{x:0,y:1},2:{x:1,y:1},3:{x:2,y:1}},
           1:{0:{x:0,y:0},1:{x:0,y:1},2:{x:1,y:1},3:{x:0,y:2}},
           2:{0:{x:0,y:0},1:{x:1,y:0},2:{x:2,y:0},3:{x:1,y:1}},
           3:{0:{x:0,y:1},1:{x:1,y:0},2:{x:1,y:1},3:{x:1,y:2}},
        },
        //  1:{0:{},1:{},2:{},3:{}},//반대기억
        //  2:{0:{},1:{},2:{},3:{}},//일자
        //  3:{0:{},1:{},2:{},3:{}},//네모
        //  4:{0:{},1:{},2:{},3:{}},//ㅗ
        //  5:{0:{},1:{},2:{},3:{}},//ㄱㄴ
        //  6:{0:{},1:{},2:{},3:{}},//ㄴㄱ
       }
       
       
      
      constructor(x,y){
        this.#app = document.getElementById("app");
        let table = document.createElement('table');
        this.#tableBody = document.createElement('tbody');
        table.appendChild(this.#tableBody);
        this.#app.appendChild(table);
        this.#x = x;
        this.#y = y;
        for(let i = 0;i<this.#y;i++){
          this.#view[i] = [];
          for(let j = 0;j<this.#x;j++){
            this.#view[i][j] = 0;
          }
        }
        this.create();
      }

      pos(){
        //x,y현재좌표와 shape,pos로 state를 만듬
        //기존 좌표 제거
        //벨리데이션 만든 state를 현재 view와 비교함
        this.#pos =this;
        this.#current.pos += 1;
        if(this.#current.pos === 4)
          this.#current.pos = 0;
      }

      create(){
        //기존상태 블럭으로
        try {
          if(this.#current.state)
          for (let index = 0; index < 4; index++) {
                this.#view[this.#current.state[index].y][this.#current.state[index].x] = 1;
          }
        } catch (error) {
          console.log("끝");
        }
//Math.floor(Math.random() * 7)
        this.#prevShape = [];
        this.#current = {x: parseInt(this.#x/2),y:0,state:{},shape:5,pos:0};
        let viewChekc = 0;
        for(let i = 0;i<this.#y;i++){

          for(let j = 0;j<this.#x;j++){
            if(this.#view[i][j] == 1 || this.#view[i][j] == 2)
              viewChekc += 1;
          }
          if(viewChekc == this.#x){
            this.#view.splice(i, 1);
            let addArr = [];
            for(let j = 0;j<this.#x;j++){
              addArr.push(0);
            }
            this.#view.unshift(addArr);
          }
          viewChekc = 0;
        }

      }
      process(xy){
        //체크성공 가정
        // if(this.move(xy)){
        //   this.create();
        // }else if(){
        //   this.pos1();
        // };

        switch (this.move(xy)) {
          case true:
          this.create();
            break;
          case false:
          this.pos1();
          break;
          default:
            break;
        }
        //계산후 땅이면 생성
        this.render();
      }
      pos1(){

        if(this.#pos){
          this.move({x:this.#posN,y:0});
          this.#pos = false;
          this.#posN = 0;
        }
      }

      move(xy){
        //현재상태 복사
        //복사된 값으로 체크
        //복사된값 문제 있을시 리턴
        //문제없을시 view에 값 넣음.
        this.#currentCopy = JSON.parse(JSON.stringify(this.#current));//느림
        let currentCopy = this.#currentCopy;
        let shape = JSON.parse(JSON.stringify(this.#shape));//느림
        let state = shape[this.#currentCopy.shape][this.#currentCopy.pos];
        this.#currentCopy.state = state;
        let prevShape = [];
        for (let index = 0; index < 4; index++) {
          currentCopy.state[index].x += xy.x + this.#current.x;
          currentCopy.state[index].y += xy.y + this.#current.y;
            //상태 저장
            prevShape.push({x:currentCopy.state[index].x,y:currentCopy.state[index].y});    
        }
        for (let index = 0; index < 4; index++) {
          if(currentCopy.state[index].x>=this.#x){
            this.#posN = -(this.#currentCopy.state[index].x - this.#x);
            console.log(this.#posN);
            return false;
          }else if(currentCopy.state[index].x<0){
            this.#posN = this.#currentCopy.state[index].x -= -this.#currentCopy.state[index].x;
            console.log(this.#posN);
            return false;
          }else if(currentCopy.state[index].y>=this.#y){
            return true;
          }else if(this.#view[currentCopy.state[index].y][currentCopy.state[index].x] == 1){
            if(xy.x != 0 && xy.y == 0)
              return false;
            return true;
          }
            //상태 저장
            prevShape.push({x:currentCopy.state[index].x,y:currentCopy.state[index].y});    
        }
        this.#prevShape.push(prevShape);
        this.#current = JSON.parse(JSON.stringify(currentCopy));//느림
        this.#current.x +=  xy.x;
        this.#current.y +=  xy.y;
        let sw = 0;
        for (let index = 0; index < 4; index++) {
          if(this.#prevShape.length>1){
            sw =1;
            this.#view[this.#prevShape[0][index].y][this.#prevShape[0][index].x] = 0;
          }
        }
        if(sw==1){
          this.#prevShape.shift();
        }
        for (let index = 0; index < 4; index++) {
          this.#view[this.#current.state[index].y][this.#current.state[index].x] = 2;
        }

      }

      render = () =>{
        this.#tableBody.innerHTML = "";
        for(let i = 0;i<this.#y;i++){
          let row = document.createElement('tr');
          for(let j = 0;j<this.#x;j++){
            let cell = document.createElement('td');
            if(this.#view[i][j] == 0){
              cell.innerHTML = '<div class="block empty"></div>';
            }else if(this.#view[i][j] == 1){
              cell.innerHTML = '<div class="block notEmpty"></div>';
            }else if(this.#view[i][j] == 2){
              cell.innerHTML = '<div class="block notEmpty"></div>';
            }else{
              throw new Error("예외적인");
            }
            row.appendChild(cell);
          }
          this.#tableBody.appendChild(row);
        }
      }
    }

    let ui =  new UI(x,15);
      let timerId = setInterval(function() {
            ui.process({x:0,y:1});
      }, 1000);

      document.onkeyup=function(){
        evet(event.keyCode);
      };

      function evet(event) {
        let xy = {x:0,y:0};
        switch (event) {
          case 32:
            xy.y += 1;
            ui.process(xy);
          break;
          case 37:
            xy.x -= 1;
            break;
          case 38:
            ui.pos();
            break;
          case 39:
            xy.x += 1;
            break;
          case 40:
            xy.y += 1;
            break;
          default:
            xy.y += 1;
            break;
        }
        ui.process(xy);
      }
        


  </script>
  
</body>
</html>