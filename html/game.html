<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/all.min.css">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/jquery-ui.css">
  <link rel="stylesheet" href="../css/jquery-ui.structure.min.css">
  <link rel="stylesheet" href="../css/jquery-ui.theme.min.css">
  <script src="../js/jquery-3.5.1.min.js"></script>
  <script src="../js/jquery-ui.js"></script>
  <link rel="stylesheet" href="../css/summernote-lite.min.css">
  <script src="../js/summernote-lite.min.js"></script>
  <script src="../js/summernote-ko-KR.min.js"></script>
  <title>Document</title>
  <style>
    #app{
      position: absolute;
      bottom: 5%;
    }
      table{
        border-collapse: separate;
        border-spacing: 0;
      }
      .block{
        border: 1px solid black;
        width: 30px;
        height: 30px;

      }
      .empty{
        background-color: white;
      }
      .notEmpty{
        background-color: black;
      }

  </style>
</head>
<body>

  <div id="app"></div>



  <script>

    //ui
    //현좌표 +1
    //블럭범위(좌표크기)를 넘으면 그대로
    //
    //좌표 존재하면 
    //


    var x = 10;
    var y = 10;


    class UI{
      #view = [];
      #x = 0;
      #y = 0;
      #app;
      #tableBody;
      #current = {};
      #prevShape = [];
      //첫번째 행기준으로 잡음.
      #shape = {
        0:{0:{0:{x:0,y:0},1:{x:1,y:0},2:{x:1,y:1},3:{x:1,y:2}},
           1:{0:{x:2,y:0},1:{x:2,y:1},2:{x:1,y:1},3:{x:0,y:1}},
           2:{0:{x:1,y:2},1:{x:0,y:2},2:{x:0,y:1},3:{x:0,y:0}},
           3:{0:{x:0,y:1},1:{x:0,y:0},2:{x:1,y:0},3:{x:2,y:0}},
        },//기억
        //  1:{0:{},1:{},2:{},3:{}},//반대기억
        //  2:{0:{},1:{},2:{},3:{}},//일자
        //  3:{0:{},1:{},2:{},3:{}},//네모
        //  4:{0:{},1:{},2:{},3:{}},//ㅗ
        //  5:{0:{},1:{},2:{},3:{}},//ㄱㄴ
        //  6:{0:{},1:{},2:{},3:{}},//ㄴㄱ
       }
       
       
      
      constructor(x,y){
        this.#app = document.getElementById("app");
        let table = document.createElement('table');
        this.#tableBody = document.createElement('tbody');
        table.appendChild(this.#tableBody);
        this.#app.appendChild(table);
        this.#x = x;
        this.#y = y;
        this.create();
        for(let i = 0;i<this.#y;i++){
          this.#view[i] = [];
          for(let j = 0;j<this.#x;j++){
            this.#view[i][j] = 0;
          }
        }
      }

      pos(){
        //x,y현재좌표와 shape,pos로 state를 만듬
        //기존 좌표 제거
        //벨리데이션 만든 state를 현재 view와 비교함
        let prevShape = [];
        console.log(this.#current.pos);
        this.#current.pos += 1;
        console.log(this.#current.pos);
        if(this.#current.pos === 4)
          this.#current.pos = 0;
        console.log(this.#current);
        let current = this.#current;
        let shape = JSON.parse(JSON.stringify(this.#shape));//느림
        let state = shape[this.#current.shape][this.#current.pos];
        for (let index = 0; index < 4; index++) {
            state[index].x += current.x;
            state[index].y += current.y;
            //상태 저장
            prevShape.push({x:state[index].x,y:state[index].y});    
        }
        this.#prevShape.push(prevShape);
        this.#current.state = state;
      }

      create(){
        this.#current = {x: parseInt(x/2),y:0,state:{},shape:0,pos:0};
        this.pos();
        console.log(this.#current);
      }
      process(move){
        //37 좌
        //38 상
        //39 우
        //40 하
        switch (move) {
          case 37:
            this.#current.x + 1;
            break;
          case 38:
            this.pos();
            break;
          case 39:
            this.#current.x - 1;
            break;
          case 40:
            this.#current.y + 1;
            this.render();
            break;
          default:
            this.#current.y + 1;
            break;
        }
        //체크성공 가정
        let current = this.#current.state;
        let sw = 0;
        for (let index = 0; index < 4; index++) {
          if(this.#prevShape.length>1){
            sw =1;
            this.#view[this.#prevShape[0][index].y][this.#prevShape[0][index].x] = 0;
          }
        }
        if(sw==1){
          this.#prevShape.shift();
        }
        for (let index = 0; index < 4; index++) {
          this.#view[current[index].y][current[index].x] = 1;
        }

        
        //계산후 땅이면 생성
        this.render();
      }

      render = () =>{
        this.#tableBody.innerHTML = "";
        for(let i = 0;i<this.#y;i++){
          let row = document.createElement('tr');
          for(let j = 0;j<this.#x;j++){
            let cell = document.createElement('td');
            if(this.#view[i][j] == 0){
              cell.innerHTML = '<div class="block empty"></div>';
            }else if(this.#view[i][j] == 1){
              cell.innerHTML = '<div class="block notEmpty"></div>';
            }else{
              console.log(this.#view);
              throw new Error("예외적인");
            }
            row.appendChild(cell);
          }
          this.#tableBody.appendChild(row);
        }
      }

    }

    let ui =  new UI(x,y);
    // let timerId = setInterval(function() {
    //       ui.process();
    // }, 1000);

      document.onkeyup=function(){
          ui.process(event.keyCode);
        };
  </script>
  
</body>
</html>